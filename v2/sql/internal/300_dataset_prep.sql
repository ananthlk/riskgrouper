
    CREATE OR REPLACE TABLE TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET_NOTES_ONLY AS
with engaged as 
    (   select fh_id, min(effective_month_start) as FIRST_month_start
        from TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET
        where is_ever_engaged =1 --and IS_ACTIVE_NEXT_90D= 1
        group by fh_id
    )
SELECT A.* 
FROM TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET A 
JOIN engaged ON engaged.FH_ID = A.FH_ID AND A.EFFECTIVE_MONTH_START >= DATEADD(MONTH,-12,engaged.FIRST_month_start)
--where A.IS_ACTIVE_NEXT_90D= 1
ORDER BY FH_ID DESC, EFFECTIVE_MONTH_START DESC;

CREATE OR REPLACE TABLE TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET_BYNE_ONLY AS
with BYNE as 
    (   select fh_id, min(effective_month_start) as FIRST_month_start
        from TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET
        where is_ever_engaged =0 AND IS_EVER_SELECTED = 1 --and IS_ACTIVE_NEXT_90D = 1
        group by fh_id
    )
SELECT A.* 
FROM TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET A 
JOIN BYNE ON BYNE.FH_ID = A.FH_ID AND A.EFFECTIVE_MONTH_START >= DATEADD(MONTH,-12,BYNE.FIRST_month_start)
--where A.IS_ACTIVE_NEXT_90D= 1
ORDER BY FH_ID DESC, EFFECTIVE_MONTH_START DESC;

CREATE OR REPLACE TABLE TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET_MASTER AS
with engaged as 
    (   select fh_id, min(effective_month_start) as FIRST_month_start
        from TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET
        where IS_EVER_ENGAGED =1 --and IS_ACTIVE_NEXT_90D= 1
        group by fh_id
    ),

NOT_ENGAGED AS (
    SELECT FH_ID, MIN(EFFECTIVE_MONTH_START) AS FIRST_month_start
    FROM TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET
    WHERE FH_ID NOT IN (SELECT DISTINCT FH_ID FROM ENGAGED ) --and IS_ACTIVE_NEXT_90D= 1
    GROUP BY FH_ID
    )
SELECT A.* 
FROM TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET A 
JOIN engaged ON engaged.FH_ID = A.FH_ID AND A.EFFECTIVE_MONTH_START <= DATEADD(MONTH,3,engaged.FIRST_month_start)
--where A.IS_ACTIVE_NEXT_90D= 1
UNION
SELECT A.* 
FROM TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET A 
JOIN NOT_ENGAGED ON NOT_ENGAGED.FH_ID = A.FH_ID AND A.EFFECTIVE_MONTH_START >= FIRST_month_start
--where A.IS_ACTIVE_NEXT_90D= 1
ORDER BY FH_ID DESC, EFFECTIVE_MONTH_START DESC;

select * from  TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET 
where fh_id in 
(
    SELECT distinct fh_id FROM 
    --TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET_NOTES_ONLY 
    TRANSFORMED_DATA._TEMP.AL_REG_CONSOLIDATED_DATASET 
    --WHERE IS_ACTIVE_NEXT_90D=0  AND EFFECTIVE_MONTH_START <='2024-08-01'
) 


 ORDER BY fh_id desc , EFFECTIVE_MONTH_START DESC ;